"use strict";(()=>{var e={};e.id=2518,e.ids=[2518],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},13682:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>x,routeModule:()=>_,serverHooks:()=>v,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>w});var a={};r.r(a),r.d(a,{GET:()=>h,OPTIONS:()=>m,POST:()=>y});var n=r(96559),s=r(48088),o=r(37719),i=r(32190),u=r(15637),l=r(72435),c=r(72289),d=r(35282);let p=c.Ik({startDate:c.Yj().optional(),endDate:c.Yj().optional(),includeAnalytics:c.au.boolean().default(!1)});async function g(e){return(process.env.ADMIN_USER_IDS?.split(",")||[]).includes(e)}async function h(e){try{let{userId:t}=auth();if(!t)return i.NextResponse.json({error:"Authentication required"},{status:401});if(!await g(t))return i.NextResponse.json({error:"Admin access required"},{status:403});let{searchParams:r}=new URL(e.url),a={startDate:r.get("startDate"),endDate:r.get("endDate"),includeAnalytics:r.get("includeAnalytics")},{startDate:n,endDate:s,includeAnalytics:o}=p.parse(a),c=await u.B.getPlatformRevenue(n,s),d=null;if(o){let e=await u.B.getRecentTransactions(1e3),t=l.R.analyzeCreatorPatterns(e),r=l.R.generateInsights(e,t),a=l.R.detectAnomalies(e);d={patterns:t.slice(0,20),insights:r,anomalies:a,summary:{total_creators_analyzed:t.length,high_risk_creators:t.filter(e=>e.volatility_score>.7).length,trending_up_creators:t.filter(e=>"up"===e.trend_direction).length,trending_down_creators:t.filter(e=>"down"===e.trend_direction).length}}}return i.NextResponse.json({success:!0,data:{revenue:c,analytics:d,generated_at:new Date().toISOString()}})}catch(e){if(console.error("Admin revenue API error:",e),e instanceof d.G)return i.NextResponse.json({error:"Invalid query parameters",details:e.errors},{status:400});return i.NextResponse.json({error:"Failed to fetch revenue data",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function y(e){try{let{userId:t}=auth();if(!t)return i.NextResponse.json({error:"Authentication required"},{status:401});if(!await g(t))return i.NextResponse.json({error:"Admin access required"},{status:403});let{startDate:r,endDate:a,includeCreatorBreakdown:n=!1,includeTransactionDetails:s=!1,groupBy:o="day"}=await e.json();if(!r||!a)return i.NextResponse.json({error:"Start date and end date are required"},{status:400});let[l,c,d]=await Promise.all([u.B.getPlatformRevenue(r,a),u.B.getDailySummaries(30),n?u.B.getTopCreators(50):Promise.resolve([])]),p=null;s&&(p=await u.B.getRecentTransactions(500));let h=c;return"week"===o?h=this.groupSummariesByWeek(c):"month"===o&&(h=this.groupSummariesByMonth(c)),i.NextResponse.json({success:!0,data:{report:{period:{startDate:r,endDate:a},revenue:l,summaries:h,creators:d,transactions:p},metadata:{generated_at:new Date().toISOString(),generated_by:t,report_type:"custom",group_by:o}}})}catch(e){return console.error("Custom revenue report API error:",e),i.NextResponse.json({error:"Failed to generate revenue report",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function m(){return new i.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}let _=new n.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/admin/revenue/route",pathname:"/api/admin/revenue",filename:"route",bundlePath:"app/api/admin/revenue/route"},resolvedPagePath:"C:\\Users\\Administrator\\Elohim\\frontend\\app\\api\\admin\\revenue\\route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:f,workUnitAsyncStorage:w,serverHooks:v}=_;function x(){return(0,o.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:w})}},21820:e=>{e.exports=require("os")},23405:e=>{e.exports=require("@supabase/ssr")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},37366:e=>{e.exports=require("dns")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},72435:(e,t,r)=>{r.d(t,{R:()=>a});class a{static detectAnomalies(e){let t=[];for(let[r,a]of Object.entries(this.groupTransactionsByCreator(e))){let e=a.filter(e=>e.amount>1e3&&"royalty"===e.transaction_type);e.length>0&&t.push({id:`large_tx_${r}_${Date.now()}`,type:"large_transaction",severity:e[0].amount>5e3?"high":"medium",description:`Creator ${r} received ${e.length} large transaction(s)`,affected_entity:r,amount:Math.max(...e.map(e=>e.amount)),detected_at:new Date().toISOString(),status:"new"});let n=a.filter(e=>"payout"===e.transaction_type).filter(e=>new Date(e.created_at)>new Date(Date.now()-864e5));n.length>3&&t.push({id:`rapid_payout_${r}_${Date.now()}`,type:"rapid_payouts",severity:"medium",description:`Creator ${r} made ${n.length} payouts in 24 hours`,affected_entity:r,detected_at:new Date().toISOString(),status:"new"});let s=a.filter(e=>"royalty"===e.transaction_type);if(s.length>0){let e=s.reduce((e,t)=>e+t.amount,0)/s.length;s.filter(t=>t.amount>5*e).length>0&&t.push({id:`unusual_pattern_${r}_${Date.now()}`,type:"unusual_pattern",severity:"low",description:`Creator ${r} has earnings significantly above average`,affected_entity:r,detected_at:new Date().toISOString(),status:"new"})}}return t}static analyzeCreatorPatterns(e){let t=this.groupTransactionsByCreator(e),r=[];for(let[e,a]of Object.entries(t)){let t=a.filter(e=>"royalty"===e.transaction_type);if(0===t.length)continue;t.reduce((e,t)=>e+t.amount,0);let n=this.groupByDate(t),s=this.groupByWeek(t),o=this.groupByMonth(t),i=Object.values(n).reduce((e,t)=>e+t.reduce((e,t)=>e+t.amount,0),0)/Object.keys(n).length,u=Object.values(s).reduce((e,t)=>e+t.reduce((e,t)=>e+t.amount,0),0)/Object.keys(s).length,l=Object.values(o).reduce((e,t)=>e+t.reduce((e,t)=>e+t.amount,0),0)/Object.keys(o).length,c=Object.values(n).map(e=>e.reduce((e,t)=>e+t.amount,0)),d=this.calculateVolatility(c),p=t.slice(-7),g=t.slice(-14,-7),h=p.reduce((e,t)=>e+t.amount,0)/p.length,y=g.reduce((e,t)=>e+t.amount,0)/g.length,m="stable";h>1.1*y?m="up":h<.9*y&&(m="down");let _=t.filter(e=>e.amount>3*i),f=_.length/t.length,w=_.length>0?_[_.length-1].created_at:void 0;r.push({creator_id:e,daily_average:i,weekly_average:u,monthly_average:l,volatility_score:d,trend_direction:m,last_spike_date:w,spike_frequency:f})}return r}static generateInsights(e,t){let r=[],a=e.filter(e=>"purchase"===e.transaction_type).reduce((e,t)=>e+t.amount,0),n=e.filter(e=>"royalty"===e.transaction_type).reduce((e,t)=>e+t.amount,0),s=a>0?n/a*100:0;s>30&&r.push({type:"risk_factor",title:"High Royalty Rate",description:`Platform is paying ${s.toFixed(1)}% in royalties, which may impact profitability`,impact:"high",recommended_action:"Consider adjusting royalty rates or platform fees",data_points:[{royalty_rate:s,total_revenue:a}]});let o=t.filter(e=>"up"===e.trend_direction&&e.monthly_average>100).sort((e,t)=>t.monthly_average-e.monthly_average).slice(0,5);o.length>0&&r.push({type:"growth_opportunity",title:"Rising Star Creators",description:`${o.length} creators showing strong upward trends`,impact:"medium",recommended_action:"Consider featuring these creators or offering incentives",data_points:o});let i=t.filter(e=>e.volatility_score>.5);return i.length>.2*t.length&&r.push({type:"risk_factor",title:"High Creator Volatility",description:`${i.length} creators have highly volatile earnings`,impact:"medium",recommended_action:"Investigate causes of volatility and consider stabilization measures",data_points:i}),r}static assessFraudRisk(e,t){let r=t.filter(t=>t.creator_id===e),a=0,n=[],s=[],o=this.getAccountAge(r),i=r.filter(e=>"royalty"===e.transaction_type).reduce((e,t)=>e+t.amount,0);o<7&&i>500&&(a+=30,n.push("New account with high immediate earnings"));let u=r.filter(e=>"payout"===e.transaction_type).filter(e=>new Date(e.created_at)>new Date(Date.now()-864e5));u.length>2&&(a+=20,n.push("Multiple rapid payouts"),s.push(...u)),r.filter(e=>e.amount%100==0&&e.amount>100).length>.5*r.length&&(a+=15,n.push("High frequency of round-number transactions"));let l="clear";return a>50?l="suspend":a>30?l="investigate":a>15&&(l="monitor"),{creator_id:e,risk_score:Math.min(a,100),indicators:n,suspicious_transactions:s,recommended_action:l}}static groupTransactionsByCreator(e){return e.reduce((e,t)=>{let r=t.creator_id||"unknown";return e[r]||(e[r]=[]),e[r].push(t),e},{})}static groupByDate(e){return e.reduce((e,t)=>{let r=new Date(t.created_at).toISOString().split("T")[0];return e[r]||(e[r]=[]),e[r].push(t),e},{})}static groupByWeek(e){return e.reduce((e,t)=>{let r=new Date(t.created_at),a=`${r.getFullYear()}-W${Math.ceil(r.getDate()/7)}`;return e[a]||(e[a]=[]),e[a].push(t),e},{})}static groupByMonth(e){return e.reduce((e,t)=>{let r=new Date(t.created_at),a=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`;return e[a]||(e[a]=[]),e[a].push(t),e},{})}static calculateVolatility(e){if(e.length<2)return 0;let t=e.reduce((e,t)=>e+t,0)/e.length,r=Math.sqrt(e.reduce((e,r)=>e+Math.pow(r-t,2),0)/e.length);return t>0?r/t:0}static getAccountAge(e){if(0===e.length)return 0;let t=e.reduce((e,t)=>new Date(t.created_at)<new Date(e.created_at)?t:e);return Math.floor((Date.now()-new Date(t.created_at).getTime())/864e5)}}},74075:e=>{e.exports=require("zlib")},79551:e=>{e.exports=require("url")},79646:e=>{e.exports=require("child_process")},79748:e=>{e.exports=require("fs/promises")},81630:e=>{e.exports=require("http")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[4447,580,2289,9526,1563,9157,5637],()=>r(13682));module.exports=a})();