(()=>{var e={};e.id=476,e.ids=[476],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{"use strict";e.exports=require("querystring")},12412:e=>{"use strict";e.exports=require("assert")},13440:e=>{"use strict";e.exports=require("util/types")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},36686:e=>{"use strict";e.exports=require("diagnostics_channel")},41204:e=>{"use strict";e.exports=require("string_decoder")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},54287:e=>{"use strict";e.exports=require("console")},55511:e=>{"use strict";e.exports=require("crypto")},57075:e=>{"use strict";e.exports=require("node:stream")},57402:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>v,routeModule:()=>l,serverHooks:()=>f,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>w});var s={};t.r(s),t.d(s,{DELETE:()=>d,POST:()=>c});var i=t(96559),o=t(48088),n=t(37719),a=t(32190),u=t(97478);async function c(e){try{let{sceneId1:r,sceneId2:t,transitionId:s,parameters:i,duration:o=.5}=await e.json();if(!r||!t||!s)return a.NextResponse.json({error:"Scene IDs and transition ID are required"},{status:400});let n=createClient(),{data:{user:c},error:d}=await n.auth.getUser();if(d||!c)return a.NextResponse.json({error:"Unauthorized"},{status:401});let{data:l,error:x}=await n.from("scenes").select("id, video_url, thumbnail_url").in("id",[r,t]).eq("user_id",c.id);if(x||!l||2!==l.length)return a.NextResponse.json({error:"Failed to fetch scene data"},{status:404});let w=l.find(e=>e.id===r),f=l.find(e=>e.id===t);if(!w||!f)return a.NextResponse.json({error:"Scenes not found"},{status:404});let v=`preview_${r}_${t}_${s}_${JSON.stringify(i)}`,{data:h}=await n.from("transition_previews").select("preview_url, expires_at").eq("cache_key",v).gt("expires_at",new Date().toISOString()).single();if(h)return a.NextResponse.json({success:!0,url:h.preview_url,duration:o,frames:Math.floor(30*o),expiresAt:h.expires_at,cached:!0});try{let e=await p({scene1Url:w.video_url,scene2Url:f.video_url,transitionId:s,parameters:i||{},duration:o}),d=new Blob([e.videoBuffer],{type:"video/mp4"}),{url:l}=await (0,u.yJ)(`previews/${v}.mp4`,d,{access:"public",addRandomSuffix:!1}),x=new Date(Date.now()+864e5).toISOString();return await n.from("transition_previews").upsert({cache_key:v,preview_url:l,scene1_id:r,scene2_id:t,transition_id:s,parameters:i||{},duration:o,expires_at:x,user_id:c.id}),a.NextResponse.json({success:!0,url:l,duration:o,frames:e.frames,expiresAt:x,cached:!1})}catch(r){console.error("Error generating preview:",r);let e=`/api/editor/preview/fallback?scene1=${encodeURIComponent(w.thumbnail_url)}&scene2=${encodeURIComponent(f.thumbnail_url)}&transition=${s}`;return a.NextResponse.json({success:!0,url:e,duration:o,frames:Math.floor(30*o),expiresAt:new Date(Date.now()+36e5).toISOString(),cached:!1,fallback:!0})}}catch(e){return console.error("Error in POST /api/editor/preview:",e),a.NextResponse.json({error:"Internal server error"},{status:500})}}async function p({scene1Url:e,scene2Url:r,transitionId:t,parameters:s,duration:i}){let o=Math.floor(30*i);return await new Promise(e=>setTimeout(e,1e3)),{videoBuffer:new ArrayBuffer(1048576),frames:o,duration:i,resolution:[1080,1920]}}async function d(e){try{let{searchParams:r}=new URL(e.url),t=r.get("cacheKey"),s="true"===r.get("clearAll"),i=createClient(),{data:{user:o},error:n}=await i.auth.getUser();if(n||!o)return a.NextResponse.json({error:"Unauthorized"},{status:401});if(s){let{error:e}=await i.from("transition_previews").delete().eq("user_id",o.id).lt("expires_at",new Date().toISOString());if(e)return console.error("Error clearing preview cache:",e),a.NextResponse.json({error:"Failed to clear cache"},{status:500});return a.NextResponse.json({success:!0,message:"Preview cache cleared"})}if(t){let{error:e}=await i.from("transition_previews").delete().eq("cache_key",t).eq("user_id",o.id);if(e)return console.error("Error deleting preview:",e),a.NextResponse.json({error:"Failed to delete preview"},{status:500});return a.NextResponse.json({success:!0,message:"Preview deleted"})}return a.NextResponse.json({error:"Cache key or clearAll parameter required"},{status:400})}catch(e){return console.error("Error in DELETE /api/editor/preview:",e),a.NextResponse.json({error:"Internal server error"},{status:500})}}let l=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/editor/preview/route",pathname:"/api/editor/preview",filename:"route",bundlePath:"app/api/editor/preview/route"},resolvedPagePath:"C:\\Users\\Administrator\\Elohim\\frontend\\app\\api\\editor\\preview\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:x,workUnitAsyncStorage:w,serverHooks:f}=l;function v(){return(0,n.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:w})}},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73496:e=>{"use strict";e.exports=require("http2")},73566:e=>{"use strict";e.exports=require("worker_threads")},74075:e=>{"use strict";e.exports=require("zlib")},74998:e=>{"use strict";e.exports=require("perf_hooks")},78335:()=>{},78474:e=>{"use strict";e.exports=require("node:events")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},84297:e=>{"use strict";e.exports=require("async_hooks")},91645:e=>{"use strict";e.exports=require("net")},94175:e=>{"use strict";e.exports=require("stream/web")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4447,580,7478],()=>t(57402));module.exports=s})();