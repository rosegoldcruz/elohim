"use strict";exports.id=5637,exports.ids=[5637],exports.modules={15637:(e,t,a)=>{a.d(t,{B:()=>c});var r=a(63874),o=a(72980),s=a(44369),n=a(31607);class i{constructor(){this.supabase=(0,r.U)()}async getPlatformRevenue(e,t){try{let a=e||new Date(Date.now()-2592e6).toISOString(),r=t||new Date().toISOString(),{data:o,error:s}=await this.supabase.from("credit_transactions").select("*").gte("created_at",a).lte("created_at",r);if(s)throw s;let n=o.filter(e=>"purchase"===e.transaction_type),i=o.filter(e=>"royalty"===e.transaction_type),c=o.filter(e=>"payout"===e.transaction_type),l=o.filter(e=>"fee"===e.transaction_type),_=n.reduce((e,t)=>e+(t.amount||0),0),d=i.reduce((e,t)=>e+(t.amount||0),0),u=Math.abs(c.reduce((e,t)=>e+(t.amount||0),0)),p=l.reduce((e,t)=>e+(t.amount||0),0),{count:g}=await this.supabase.from("creator_wallets").select("*",{count:"exact",head:!0}).gt("total_earnings",0);return{gross_revenue:_,net_revenue:_-d-p,total_royalties_paid:d,total_payouts_processed:u,platform_fees_collected:p,active_creators:g||0,total_transactions:o.length,period_start:a,period_end:r}}catch(e){throw console.error("Error getting platform revenue:",e),e}}async getTopCreators(e=20){try{let{data:t,error:a}=await this.supabase.from("creator_wallets").select(`
          creator_id,
          balance,
          total_earnings,
          total_payouts,
          payout_method,
          created_at,
          updated_at
        `).order("total_earnings",{ascending:!1}).limit(e);if(a)throw a;return await Promise.all(t.map(async e=>{let{data:t}=await this.supabase.from("profiles").select("email").eq("id",e.creator_id).single(),{data:a}=await this.supabase.from("credit_transactions").select("created_at").eq("creator_id",e.creator_id).eq("transaction_type","payout").order("created_at",{ascending:!1}).limit(1).single();return{creator_id:e.creator_id,creator_email:t?.email,total_earnings:e.total_earnings,total_payouts:e.total_payouts,pending_balance:e.balance,video_count:0,avg_earnings_per_video:0,last_payout_date:a?.created_at,payout_method:e.payout_method,status:e.total_earnings>0?"active":"inactive",created_at:e.created_at}}))}catch(e){throw console.error("Error getting top creators:",e),e}}async getDailySummaries(e=30){try{let t=new Date(Date.now()-864e5*e),{data:a,error:r}=await this.supabase.from("credit_transactions").select("*").gte("created_at",t.toISOString()).order("created_at",{ascending:!0});if(r)throw r;let o={};return a.forEach(e=>{let t=new Date(e.created_at).toISOString().split("T")[0];o[t]||(o[t]=[]),o[t].push(e)}),Object.entries(o).map(([e,t])=>{let a=t.filter(e=>"purchase"===e.transaction_type).reduce((e,t)=>e+(t.amount||0),0),r=t.filter(e=>"royalty"===e.transaction_type).reduce((e,t)=>e+(t.amount||0),0),o=Math.abs(t.filter(e=>"payout"===e.transaction_type).reduce((e,t)=>e+(t.amount||0),0));return{date:e,purchases:a,royalties:r,payouts:o,net_flow:a-r-o,transaction_count:t.length}}).sort((e,t)=>e.date.localeCompare(t.date))}catch(e){throw console.error("Error getting daily summaries:",e),e}}async getRecentTransactions(e=100,t,a){try{let r=this.supabase.from("credit_transactions").select(`
          *,
          profiles!creator_id(email)
        `).order("created_at",{ascending:!1}).limit(e);t&&(r=r.eq("transaction_type",t)),a&&(r=r.eq("creator_id",a));let{data:o,error:s}=await r;if(s)throw s;return o||[]}catch(e){throw console.error("Error getting recent transactions:",e),e}}async getAdminMetrics(){try{let[e,t,a,r]=await Promise.all([this.getPlatformRevenue(),this.getTopCreators(10),this.getRecentTransactions(50),this.getDailySummaries(30)]),o=await this.getPlatformRevenue(new Date(Date.now()-5184e6).toISOString(),new Date(Date.now()-2592e6).toISOString()),s=o.gross_revenue>0?(e.gross_revenue-o.gross_revenue)/o.gross_revenue*100:0,n=o.active_creators>0?(e.active_creators-o.active_creators)/o.active_creators*100:0,i=o.total_transactions>0?(e.total_transactions-o.total_transactions)/o.total_transactions*100:0;return{revenue:e,top_creators:t,recent_transactions:a,daily_summaries:r,anomaly_alerts:[],growth_metrics:{revenue_growth:s,creator_growth:n,transaction_growth:i}}}catch(e){throw console.error("Error getting admin metrics:",e),e}}async exportTransactionData(e,t,a="csv"){try{let{data:r,error:o}=await this.supabase.from("credit_transactions").select(`
          *,
          profiles!creator_id(email)
        `).gte("created_at",e).lte("created_at",t).order("created_at",{ascending:!0});if(o)throw o;if("json"===a)return r||[];let s=(r||[]).map(e=>[new Date(e.created_at).toISOString().split("T")[0],e.id,e.transaction_type,e.creator_id||"",e.profiles?.email||"",e.amount,e.status,`"${(e.description||"").replace(/"/g,'""')}"`,e.reference_id||""].join(","));return["Date,Transaction ID,Type,Creator ID,Creator Email,Amount,Status,Description,Reference ID",...s].join("\n")}catch(e){throw console.error("Error exporting transaction data:",e),e}}async getCreatorPerformance(e){try{let t=new Date(Date.now()-7776e6),{data:a,error:r}=await this.supabase.from("credit_transactions").select("created_at, amount").eq("creator_id",e).eq("transaction_type","royalty").gte("created_at",t.toISOString()).order("created_at",{ascending:!0});if(r)throw r;let o={};a?.forEach(e=>{let t=new Date(e.created_at).toISOString().split("T")[0];o[t]=(o[t]||0)+e.amount});let s=Object.entries(o).map(([e,t])=>({date:e,amount:t})),{data:n,error:i}=await this.supabase.from("credit_transactions").select("*").eq("creator_id",e).eq("transaction_type","payout").order("created_at",{ascending:!1}).limit(20);if(i)throw i;let{data:c,error:l}=await this.supabase.from("creator_wallets").select("creator_id, total_earnings").order("total_earnings",{ascending:!1});if(l)throw l;let _=(c?.findIndex(t=>t.creator_id===e)||-1)+1;return{earnings_trend:s,payout_history:n||[],performance_metrics:{total_videos:0,avg_earnings_per_video:0,best_performing_video:null,earnings_rank:_}}}catch(e){throw console.error("Error getting creator performance:",e),e}}async getPlatformHealth(){try{let e=new Date(Date.now()-864e5),{data:t,error:a}=await this.supabase.from("credit_transactions").select("status, created_at").gte("created_at",e.toISOString());if(a)throw a;let r=t?.length||0,o=t?.filter(e=>"failed"===e.status).length||0,s=r>0?o/r*100:0,{count:n}=await this.supabase.from("payout_requests").select("*",{count:"exact",head:!0}).eq("status","pending"),i="healthy";return s>10?i="critical":s>5&&(i="warning"),{system_status:i,active_users_24h:0,failed_transactions_rate:s,avg_payout_time:0,pending_payouts_count:n||0,error_rate:s}}catch(e){throw console.error("Error getting platform health:",e),e}}async runDailyOps(){console.log("\uD83E\uDD16 Starting daily automated operations...");try{console.log("\uD83D\uDCCA Generating daily exports...");let[e,t,a]=await Promise.all([o.E?.generateDailyCSV()||{success:!1,export_id:"failed",generated_at:new Date().toISOString(),error:"Exporter not available"},o.E?.generateWeeklyRevenue()||{success:!1,export_id:"failed",generated_at:new Date().toISOString(),error:"Exporter not available"},o.E?.generateMonthlyCreators()||{success:!1,export_id:"failed",generated_at:new Date().toISOString(),error:"Exporter not available"}]);console.log("\uD83D\uDD0D Running fraud detection scan...");let r=await s.E?.checkForFraud()||{alerts:[],stats:{high_risk_creators:0},actions_taken:[]};console.log("\uD83C\uDFE5 Checking platform health...");let i=await this.getPlatformHealth(),c=await this.getPlatformRevenue();await this.getRecentTransactions(1e3),console.log("\uD83D\uDCE7 Sending daily summary...");let l=await n.q?.sendDailySummary(c.gross_revenue,c.total_transactions,r.alerts.length,[e.success?`Daily CSV: ${e.record_count} records`:"Daily CSV: Failed",t.success?`Weekly Revenue: ${t.record_count} days`:"Weekly Revenue: Failed",a.success?`Monthly Creators: ${a.record_count} creators`:"Monthly Creators: Failed"])||!1;e.success&&e.file_path&&await n.q?.sendExportNotification("Daily Transactions",e.file_path,e.file_size||0,e.record_count||0),await o.E?.cleanupOldExports(30);let _={exports:{daily_csv:e,weekly_revenue:t,monthly_creators:a},fraud_scan:{alerts:r.alerts.length,actions_taken:r.actions_taken.length,high_risk_creators:r.stats.high_risk_creators},platform_health:i,notifications_sent:l};return console.log("âœ… Daily operations completed successfully"),_}catch(e){throw console.error("âŒ Daily operations failed:",e),await n.q?.sendSystemAlert("system_down","Daily operations failed",{error:e instanceof Error?e.message:"Unknown error"}),e}}async runEmergencyFraudSweep(){console.log("\uD83D\uDEA8 Running emergency fraud sweep...");try{let e=await s.E?.checkForFraud()||{alerts:[],actions_taken:[],stats:{high_risk_creators:0}},t=e.alerts.filter(e=>"critical"===e.severity),a=e.actions_taken.filter(e=>e.includes("Suspended")).length;return t.length>0&&await n.q?.sendSystemAlert("security_breach",`Emergency fraud sweep detected ${t.length} critical alerts`,{alerts:t}),{critical_alerts:t.length,suspended_creators:a,actions_taken:e.actions_taken}}catch(e){throw console.error("Emergency fraud sweep failed:",e),e}}async generateWeeklyReport(){console.log("\uD83D\uDCC8 Generating weekly executive report...");try{let e=new Date().toISOString(),t=new Date(Date.now()-6048e5).toISOString(),[a,r,s]=await Promise.all([this.getPlatformRevenue(t,e),this.getTopCreators(20),this.getDailySummaries(7)]),i=new Date(Date.now()-12096e5).toISOString(),c=new Date(Date.now()-6048e5).toISOString(),l=await this.getPlatformRevenue(i,c),_=l.gross_revenue>0?(a.gross_revenue-l.gross_revenue)/l.gross_revenue*100:0;r.slice(0,10),a.gross_revenue,r.filter(e=>"active"===e.status).length,a.total_transactions,await o.E?.generateFullReport();let d=`ðŸ“Š AEON Weekly Executive Report - ${new Date().toLocaleDateString()}`,u=`
AEON Platform Weekly Report

REVENUE PERFORMANCE
â€¢ Current Week: $${(.01*a.gross_revenue).toFixed(2)}
â€¢ Previous Week: $${(.01*l.gross_revenue).toFixed(2)}
â€¢ Growth: ${_>=0?"+":""}${_.toFixed(1)}%

KEY METRICS
â€¢ Total Transactions: ${a.total_transactions.toLocaleString()}
â€¢ Active Creators: ${a.active_creators}
â€¢ Average Daily Revenue: $${(a.gross_revenue/7*.01).toFixed(2)}

TOP PERFORMERS
${r.slice(0,5).map((e,t)=>`${t+1}. ${e.creator_email||e.creator_id.slice(0,8)} - $${(.01*e.total_earnings).toFixed(2)}`).join("\n")}

Full report attached.
Dashboard: https://smart4technology.com/admin/dashboard
      `.trim();return await n.q?.sendCustomEmail({to:process.env.EXECUTIVE_EMAILS?.split(",")||process.env.ADMIN_EMAILS?.split(",")||["admin@aeon.com"],subject:d,text:u,priority:"normal"}),console.log("âœ… Weekly executive report sent"),!0}catch(e){return console.error("Failed to generate weekly report:",e),!1}}async monitorSystemHealth(){try{let e=await this.getPlatformHealth();"critical"===e.system_status&&await n.q?.sendSystemAlert("system_down","Platform health check failed - critical status detected",e),e.error_rate>10&&await n.q?.sendSystemAlert("database_error",`High error rate detected: ${e.error_rate}%`,{error_rate:e.error_rate}),e.pending_payouts_count>100&&await n.q?.sendAlert("High Pending Payouts",`${e.pending_payouts_count} payouts are pending processing`)}catch(e){console.error("System health monitoring failed:",e),await n.q?.sendSystemAlert("system_down","System health monitoring failed",{error:e instanceof Error?e.message:"Unknown error"})}}}let c=new i},72980:(e,t,a)=>{a.d(t,{E:()=>c});var r=a(63874);let o=null,s=null,n=null;o=a(33944).Parser,s=a(79748),n=a(33873);class i{constructor(){this.supabase=(0,r.U)(),this.exportDir=process.env.EXPORT_DIR||"./exports",this.ensureExportDirectory()}async generateDailyCSV(){if(!o||!s||!n)return{success:!1,export_id:`daily_transactions_${Date.now()}`,generated_at:new Date().toISOString(),error:"Server-side only operation"};let e=`daily_transactions_${Date.now()}`;try{let t=new Date;t.setDate(t.getDate()-1);let a=t.toISOString().split("T")[0]+"T00:00:00.000Z",r=t.toISOString().split("T")[0]+"T23:59:59.999Z",{data:i,error:c}=await this.supabase.from("credit_transactions").select(`
          *,
          profiles!creator_id(email)
        `).gte("created_at",a).lte("created_at",r).order("created_at",{ascending:!0});if(c)throw c;let l=(i||[]).map(e=>({id:e.id,created_at:e.created_at,transaction_type:e.transaction_type,amount:e.amount,creator_id:e.creator_id||"",creator_email:e.profiles?.email||"",status:e.status,description:e.description||"",reference_id:e.reference_id||""})),_=new o({fields:["id","created_at","transaction_type","amount","creator_id","creator_email","status","description","reference_id"]}).parse(l),d=`transactions_${t.toISOString().split("T")[0]}.csv`,u=n.join(this.exportDir,d);await s.writeFile(u,_);let p=await s.stat(u);return{success:!0,file_path:u,file_size:p.size,record_count:l.length,export_id:e,generated_at:new Date().toISOString()}}catch(t){return console.error("Daily CSV export failed:",t),{success:!1,export_id:e,generated_at:new Date().toISOString(),error:t instanceof Error?t.message:"Export failed"}}}async generateWeeklyRevenue(){let e=`weekly_revenue_${Date.now()}`;try{let t=new Date,a=new Date;a.setDate(a.getDate()-7);let{data:r,error:o}=await this.supabase.from("credit_transactions").select("*").gte("created_at",a.toISOString()).lte("created_at",t.toISOString());if(o)throw o;let i=r?.filter(e=>"purchase"===e.transaction_type)||[],c=r?.filter(e=>"royalty"===e.transaction_type)||[],l=r?.filter(e=>"payout"===e.transaction_type)||[],_=i.reduce((e,t)=>e+(t.amount||0),0),d=c.reduce((e,t)=>e+(t.amount||0),0),u=Math.abs(l.reduce((e,t)=>e+(t.amount||0),0)),p={};r?.forEach(e=>{let t=new Date(e.created_at).toISOString().split("T")[0];p[t]||(p[t]={purchases:0,royalties:0,payouts:0,transactions:0}),"purchase"===e.transaction_type&&(p[t].purchases+=e.amount||0),"royalty"===e.transaction_type&&(p[t].royalties+=e.amount||0),"payout"===e.transaction_type&&(p[t].payouts+=Math.abs(e.amount||0)),p[t].transactions+=1});let g={summary:{period:`${a.toISOString().split("T")[0]} to ${t.toISOString().split("T")[0]}`,gross_revenue:_,net_revenue:_-d,total_royalties:d,total_payouts:u,total_transactions:r?.length||0},daily_breakdown:Object.entries(p).map(([e,t])=>({date:e,...t,net_flow:t.purchases-t.royalties-t.payouts}))},y=`revenue_weekly_${t.toISOString().split("T")[0]}.json`,h=n.join(this.exportDir,y);await s.writeFile(h,JSON.stringify(g,null,2));let m=await s.stat(h);return{success:!0,file_path:h,file_size:m.size,record_count:Object.keys(p).length,export_id:e,generated_at:new Date().toISOString()}}catch(t){return console.error("Weekly revenue export failed:",t),{success:!1,export_id:e,generated_at:new Date().toISOString(),error:t instanceof Error?t.message:"Export failed"}}}async generateMonthlyCreators(){let e=`monthly_creators_${Date.now()}`;try{let{data:t,error:a}=await this.supabase.from("creator_wallets").select(`
          *,
          profiles!creator_id(email)
        `).order("total_earnings",{ascending:!1});if(a)throw a;let r=new Date;r.setDate(r.getDate()-30);let i=await Promise.all((t||[]).map(async e=>{let{data:t}=await this.supabase.from("credit_transactions").select("transaction_type, amount").eq("creator_id",e.creator_id).gte("created_at",r.toISOString()),a=t?.filter(e=>"royalty"===e.transaction_type).reduce((e,t)=>e+(t.amount||0),0)||0,o=Math.abs(t?.filter(e=>"payout"===e.transaction_type).reduce((e,t)=>e+(t.amount||0),0)||0);return{creator_id:e.creator_id,email:e.profiles?.email||"",total_earnings:e.total_earnings,total_payouts:e.total_payouts,current_balance:e.balance,monthly_earnings:a,monthly_payouts:o,payout_method:e.payout_method,status:e.total_earnings>0?"active":"inactive",created_at:e.created_at}})),c=new o({fields:["creator_id","email","total_earnings","total_payouts","current_balance","monthly_earnings","monthly_payouts","payout_method","status","created_at"]}).parse(i),l=`creators_monthly_${new Date().toISOString().split("T")[0]}.csv`,_=n.join(this.exportDir,l);await s.writeFile(_,c);let d=await s.stat(_);return{success:!0,file_path:_,file_size:d.size,record_count:i.length,export_id:e,generated_at:new Date().toISOString()}}catch(t){return console.error("Monthly creators export failed:",t),{success:!1,export_id:e,generated_at:new Date().toISOString(),error:t instanceof Error?t.message:"Export failed"}}}async generateFullReport(){let e=`full_report_${Date.now()}`;try{let[t,a,r]=await Promise.all([this.generateDailyCSV(),this.generateWeeklyRevenue(),this.generateMonthlyCreators()]),o={generated_at:new Date().toISOString(),exports:{daily_transactions:t,weekly_revenue:a,monthly_creators:r},platform_status:"operational",total_files:3,total_size:(t.file_size||0)+(a.file_size||0)+(r.file_size||0)},i=`platform_report_${new Date().toISOString().split("T")[0]}.json`,c=n.join(this.exportDir,i);await s.writeFile(c,JSON.stringify(o,null,2));let l=await s.stat(c);return{success:!0,file_path:c,file_size:l.size,record_count:1,export_id:e,generated_at:new Date().toISOString()}}catch(t){return console.error("Full report export failed:",t),{success:!1,export_id:e,generated_at:new Date().toISOString(),error:t instanceof Error?t.message:"Export failed"}}}async cleanupOldExports(e=30){try{let t=await s.readdir(this.exportDir),a=new Date;for(let r of(a.setDate(a.getDate()-e),t)){let e=n.join(this.exportDir,r);(await s.stat(e)).mtime<a&&(await s.unlink(e),console.log(`Cleaned up old export: ${r}`))}}catch(e){console.error("Export cleanup failed:",e)}}async ensureExportDirectory(){if(s)try{await s.access(this.exportDir)}catch{await s.mkdir(this.exportDir,{recursive:!0})}}}let c=new i}};